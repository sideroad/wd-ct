#!/usr/bin/env node

// Run WdCT.
var opts = require('opts'),
    prompt = require('prompt'),
    fs = require('fs'),
    options = {};

opts.parse([
  {
    'short': 't',
    'long': 'testcase',
    'description': 'Target testcase file',
    'value': true
  },
  {
    'short': 'i',
    'long': 'interaction',
    'description': 'Target interaction file',
    'value': true
  },
  {
    'short': 'nl',
    'long': 'no-logging',
    'description': 'Not output logging',
  },
  {
    'short': 'b',
    'long': 'browsers',
    'description': 'Browser ( comma separatted )',
    'value': true
  },
  {
    'short': 'nc',
    'long': 'no-color',
    'description': 'Not apply color to console',
  },
  {
    'short': 's',
    'long': 'scaffold',
    'description': 'Generate sample script and csv from template'
  },
  {
    'short': 'sw',
    'long': 'stepwise',
    'description': 'Stepwise execution'
  },
  {
    'short': 'bp',
    'long': 'breakpoint',
    'description': 'Set break point after the command executed',
    'value': true
  }
]);

if(opts.get('scaffold')){

  prompt.start();
  prompt.get({
    properties: {
      ok: {
        pattern: /^y|n$/,
        description: 'Are you ok to generate interaction.js and testcase.csv? (y / n)',
        default: 'y',
        required: true
      },
      interaction: {
        pattern: /^.*\.js$/,
        description: 'Input interaction script name',
        default: 'interaction.js',
        required: true
      },
      testcase: {
        pattern: /^.*\.csv$/,
        description: 'Input testcase CSV file name',
        default: 'testcase.csv',
        required: true        
      }
    }
  }, function(err, results){
    if(results.ok){
      fs.createReadStream(__dirname+'/../template/interaction.js').pipe(fs.createWriteStream(results.interaction));
      fs.createReadStream(__dirname+'/../template/testcase.csv').pipe(fs.createWriteStream(results.testcase));
    }

  });
  

} else {

  options.testcase = opts.get('testcase');
  options.interaction = opts.get('interaction');

  if(!options.testcase && 
     !options.interaction ){
    opts.help();
    process.exit();
  }

  var noLogging = opts.get('no-logging');
  if(noLogging) {
    options.debug = false;
  }

  var noColor = opts.get('no-color');
  if(noColor) {
    options.color = false;
  }

  var browsers = opts.get('browsers');
  if(browsers){
    options.browsers =  browsers.split(',');
  }

  var stepwise = opts.get('stepwise');
  if(stepwise){
    options.stepwise = true;
  }

  var breakpoint = opts.get('breakpoint');
  if(breakpoint){
    options.breakpoint = breakpoint;
  }

  var WdCT = require('../src/wd-ct');
  new WdCT( options );
}

